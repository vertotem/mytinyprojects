<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF A3 åˆ‡ A4ï¼ˆå¸¦é¢„è§ˆï¼Œå“åº”å¼ï¼‰</title>
    
    <script src="./pdf-lib.min.js"></script>
    
    <script src="./pdf.min.js"></script>
    <script>
        // å¿…é¡»é…ç½® workerSrc
        pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.min.js';
    </script>
    
    <style>
        /* å“åº”å¼åŸºç¡€ */
        body { 
            font-family: sans-serif; 
            margin: 0; 
            background-color: #f4f4f4; 
            padding: 10px;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        h1 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* æ§åˆ¶é¢æ¿å’Œé¢„è§ˆåŒºåŸŸçš„ Flex å¸ƒå±€ */
        .main-content {
            display: flex;
            flex-wrap: wrap; /* å…è®¸åœ¨å°å±å¹•ä¸Šæ¢è¡Œ */
            gap: 20px;
        }
        .control-panel, .visualization-container {
            padding: 15px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            background-color: #f9f9f9;
        }
        .control-panel {
            flex: 1 1 300px; /* æœ€å°å®½åº¦ 300pxï¼Œä¼˜å…ˆå æ®æ›´å¤šç©ºé—´ */
        }
        .visualization-container {
            flex: 2 1 500px; /* æœ€å°å®½åº¦ 500pxï¼Œå æ®å‰©ä½™ç©ºé—´ */
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* é¢„è§ˆç”»å¸ƒå®¹å™¨ */
        #previewWrapper {
            position: relative;
            width: 100%;
            height: auto;
            max-width: 842px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œä½†å“åº”å¼ */
        }
        #previewCanvas, #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 1px solid #333;
            box-sizing: border-box;
        }
        #overlayCanvas {
            z-index: 10; /* ç¡®ä¿åˆ‡å‰²çº¿åœ¨ PDF å†…å®¹ä¹‹ä¸Š */
        }
        
        /* æ‹–æ‹½æ§åˆ¶ç‚¹æ ·å¼ */
        .drag-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #007bff;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            touch-action: none; /* é˜²æ­¢è§¦æ‘¸æ—¶çš„é»˜è®¤è¡Œä¸º */
        }
        
        .drag-handle:hover {
            background-color: #0056b3;
            transform: scale(1.2);
        }
        
        .drag-handle.dragging {
            background-color: #ff6b6b;
            transform: scale(1.3);
        }
        
        /* è¾¹ç•Œæ§åˆ¶ç‚¹ */
        .boundary-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #28a745;
            border: 3px solid white;
            border-radius: 3px;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            touch-action: none; /* é˜²æ­¢è§¦æ‘¸æ—¶çš„é»˜è®¤è¡Œä¸º */
        }
        
        .boundary-handle:hover {
            background-color: #1e7e34;
            transform: scale(1.2);
        }
        
        .boundary-handle.dragging {
            background-color: #ff6b6b;
            transform: scale(1.3);
        }
        
        /* ç§»åŠ¨è®¾å¤‡ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 15px;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .control-panel, .visualization-container {
                flex: none;
                width: 100%;
            }
            
            .drag-handle {
                width: 24px;
                height: 24px;
                border-width: 4px;
            }
            
            .boundary-handle {
                width: 20px;
                height: 20px;
                border-width: 4px;
            }
            
            .info {
                font-size: 14px;
                padding: 8px;
            }
            
            .control-panel button {
                padding: 12px 15px;
                font-size: 16px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .drag-handle {
                width: 28px;
                height: 28px;
                border-width: 5px;
            }
            
            .boundary-handle {
                width: 24px;
                height: 24px;
                border-width: 5px;
            }
            
            .info {
                font-size: 13px;
            }
        }
        
        /* è¾¹ç•Œæ§åˆ¶ç‚¹ä½ç½®è°ƒæ•´ */
        .boundary-handle.top, .boundary-handle.bottom {
            left: 50%;
            transform: translateX(-50%);
        }
        
        .boundary-handle.left, .boundary-handle.right {
            top: 50%;
            transform: translateY(-50%);
        }
        
        .boundary-handle.top-left {
            top: 0;
            left: 0;
        }
        
        .boundary-handle.top-right {
            top: 0;
            right: 0;
        }
        
        .boundary-handle.bottom-left {
            bottom: 0;
            left: 0;
        }
        
        .boundary-handle.bottom-right {
            bottom: 0;
            right: 0;
        }
        
        /* è¾…åŠ©ç±» */
        .info { margin-top: 15px; padding: 10px; background-color: #ffeeba; border: 1px solid #ffcc00; color: #856404; border-radius: 5px; }
        .warning { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .control-panel button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        .control-panel button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

<div class="container">
    <h1>PDF A3 åˆ‡ A4 å·¥å…·</h1>

    <div class="info">
        æç¤ºï¼šæœ¬å·¥å…·åœ¨æµè§ˆå™¨ä¸­çº¯å‰ç«¯è¿è¡Œï¼Œæ–‡ä»¶ä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚
    </div>
    <div id="sizeWarning" class="info warning" style="display: none;">
        **æ³¨æ„ï¼š** åŸå§‹æ–‡ä»¶å°ºå¯¸ä¿¡æ¯ç¼ºå¤±æˆ–æ— æ•ˆï¼Œç¨‹åºå°†**å¼ºåˆ¶ä½¿ç”¨ A3 æ¨ªå‘å°ºå¯¸** ($842 \text{pts} \times 595 \text{pts}$) è¿›è¡Œåˆ‡å‰²ã€‚
    </div>

    <div class="main-content">
        <div class="control-panel">
            <label for="pdfFile">æ­¥éª¤ 1: ä¸Šä¼  PDF æ–‡ä»¶</label>
            <input type="file" id="pdfFile" accept="application/pdf">

            <br/><label for="splitMode" style="margin-top: 15px;">æ­¥éª¤ 2: é€‰æ‹©åˆ‡å‰²æ–¹å‘</label>
            <select id="splitMode">
                <option value="vertical">å‚ç›´åˆ‡å‰²ï¼ˆé•¿è¾¹å¯¹åŠåˆ† - å·¦å³ä¸¤é¡µï¼‰</option>
                <option value="horizontal">æ°´å¹³åˆ‡å‰²ï¼ˆçŸ­è¾¹å¯¹åŠåˆ† - ä¸Šä¸‹ä¸¤é¡µï¼‰</option>
            </select>
            
            <button id="splitBtn" onclick="splitAndDownload()" disabled>æ­¥éª¤ 3: åˆ‡å‰²å¹¶ç”Ÿæˆ A4 PDF</button>
            <button id="downloadBtn" style="display: none;">ä¸‹è½½åˆ†å‰²åçš„ PDF</button>

            <p style="margin-top: 20px;">é¡µé¢å°ºå¯¸ (pts): <span id="pageDimensions">N/A</span></p>
        </div>

        <div class="visualization-container">
            <h2>åŸå§‹é¡µé¢é¢„è§ˆåŠåˆ‡å‰²ç¤ºæ„</h2>
            <div class="info" style="margin-bottom: 15px;">
                <strong>æ‹–æ‹½è°ƒæ•´è¯´æ˜ï¼š</strong><br>
                â€¢ <span style="color: #007bff;">è“è‰²åœ†ç‚¹</span>ï¼šæ‹–æ‹½è°ƒæ•´åˆ†å‰²çº¿ä½ç½®<br>
                â€¢ <span style="color: #28a745;">ç»¿è‰²æ–¹å—</span>ï¼šæ‹–æ‹½è°ƒæ•´è¾¹ç•Œä½ç½®<br>
                â€¢ æ¯éƒ¨åˆ†å°†è‡ªåŠ¨é“ºæ»¡A4é¡µé¢<br>
                <span class="mobile-hint" style="display: none; color: #666; font-size: 12px;">
                    ğŸ“± ç§»åŠ¨è®¾å¤‡ï¼šç›´æ¥è§¦æ‘¸æ‹–æ‹½æ§åˆ¶ç‚¹
                </span>
            </div>
            <div id="previewWrapper">
                <canvas id="previewCanvas"></canvas>
                <canvas id="overlayCanvas"></canvas>
                
                <!-- åˆ†å‰²çº¿æ‹–æ‹½æ§åˆ¶ç‚¹ -->
                <div id="splitHandle" class="drag-handle" style="display: none;"></div>
                
                <!-- è¾¹ç•Œæ§åˆ¶ç‚¹ -->
                <div id="topHandle" class="boundary-handle top" style="display: none;"></div>
                <div id="bottomHandle" class="boundary-handle bottom" style="display: none;"></div>
                <div id="leftHandle" class="boundary-handle left" style="display: none;"></div>
                <div id="rightHandle" class="boundary-handle right" style="display: none;"></div>
            </div>
            <p id="previewHint">è¯·ä¸Šä¼  PDF æ–‡ä»¶ä»¥æŸ¥çœ‹é¢„è§ˆã€‚</p>
        </div>
    </div>
</div>

<script>
    // pdf-lib éƒ¨åˆ†
    const { PDFDocument } = PDFLib;
    
    let originalPdfDoc = null;
    let splitPdfBytes = null;
    let pdfDataUrl = null; // ç”¨äº pdf.js æ¸²æŸ“çš„ Data URL
    let originalFileName = ''; // ã€æ–°å¢ã€‘ç”¨äºå­˜å‚¨åŸå§‹æ–‡ä»¶å
    
    // å‡å®šçš„ A3 æ¨ªå‘å°ºå¯¸
    const ASSUMED_A3_WIDTH = 841.89; 
    const ASSUMED_A3_HEIGHT = 595.28; 

    let pageDims = { width: 0, height: 0 }; 
    
    // æ‹–æ‹½ç›¸å…³å˜é‡
    let isDragging = false;
    let dragTarget = null;
    let dragStartPos = { x: 0, y: 0 };
    let customBoundaries = { top: 0, bottom: 1, left: 0, right: 1 }; // ç›¸å¯¹ä½ç½® (0-1)
    let customSplitPosition = 0.5; // åˆ†å‰²çº¿ä½ç½® (0-1)

    // DOM å…ƒç´ 
    const pdfFileEl = document.getElementById('pdfFile');
    const splitBtn = document.getElementById('splitBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const pageDimensionsEl = document.getElementById('pageDimensions');
    const overlayCanvas = document.getElementById('overlayCanvas');
    const previewCanvas = document.getElementById('previewCanvas');
    const ctx = overlayCanvas.getContext('2d');
    const splitModeEl = document.getElementById('splitMode');
    const sizeWarningEl = document.getElementById('sizeWarning');
    const previewWrapper = document.getElementById('previewWrapper');
    const previewHint = document.getElementById('previewHint');
    
    // æ‹–æ‹½æ§åˆ¶ç‚¹å…ƒç´ 
    const splitHandle = document.getElementById('splitHandle');
    const topHandle = document.getElementById('topHandle');
    const bottomHandle = document.getElementById('bottomHandle');
    const leftHandle = document.getElementById('leftHandle');
    const rightHandle = document.getElementById('rightHandle');

    // --- PDF.js æ¸²æŸ“é€»è¾‘ ---
    async function renderPagePreview(dataUrl, pageNumber = 1) {
        previewHint.textContent = "æ­£åœ¨åŠ è½½é¢„è§ˆ...";
        try {
            const pdfDocument = await pdfjsLib.getDocument({ url: dataUrl }).promise;
            const page = await pdfDocument.getPage(pageNumber);
            const viewport = page.getViewport({ scale: 1.0 });

            // 1. è®¾ç½® pageDims (pt å•ä½)
            pageDims = { 
                width: viewport.width, 
                height: viewport.height 
            };

            // 2. æ¸²æŸ“ PDF å†…å®¹åˆ° previewCanvas
            const scaleFactor = previewWrapper.clientWidth / viewport.width;
            const scaledViewport = page.getViewport({ scale: scaleFactor });

            previewCanvas.height = scaledViewport.height;
            previewCanvas.width = scaledViewport.width;

            const renderContext = {
                canvasContext: previewCanvas.getContext('2d'),
                viewport: scaledViewport,
            };
            await page.render(renderContext).promise;

            // 3. è°ƒæ•´ Wrapper å®¹å™¨çš„é«˜åº¦ä»¥åŒ¹é…æ¸²æŸ“çš„ Canvas
            previewWrapper.style.paddingTop = (scaledViewport.height / scaledViewport.width) * 100 + '%';
            
            // 4. é‡æ–°ç»˜åˆ¶åˆ‡å‰²ç¤ºæ„å›¾ (åŸºäºæ–°çš„æ¸²æŸ“å°ºå¯¸)
            drawVisualization(previewCanvas.width, previewCanvas.height, splitModeEl.value);

            // 5. æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            pageDimensionsEl.textContent = `${pageDims.width.toFixed(2)} pts x ${pageDims.height.toFixed(2)} pts`;
            previewHint.textContent = "";

            // å°ºå¯¸ç¼ºå¤±æ£€æŸ¥ (é’ˆå¯¹åˆ‡å‰²é€»è¾‘çš„ pageDims)
            if (!pageDims.width || !pageDims.height || pageDims.width <= 0 || pageDims.height <= 0 || isNaN(pageDims.width) || isNaN(pageDims.height)) {
                // å¦‚æœå°ºå¯¸æ— æ•ˆæˆ–ç¼ºå¤±ï¼Œå¼ºåˆ¶ä½¿ç”¨å‡å®šçš„ A3 å°ºå¯¸
                pageDims = { 
                    width: ASSUMED_A3_WIDTH, 
                    height: ASSUMED_A3_HEIGHT
                };
                pageDimensionsEl.textContent = `N/A (å¼ºåˆ¶å‡å®šä¸º ${pageDims.width.toFixed(2)} pts x ${pageDims.height.toFixed(2)} pts)`;
                sizeWarningEl.style.display = 'block';
            } else {
                 sizeWarningEl.style.display = 'none';
            }


        } catch (error) {
            previewHint.textContent = "PDF é¢„è§ˆåŠ è½½å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½æŸåæˆ–æ ¼å¼ä¸æ”¯æŒã€‚";
            console.error("PDF.js æ¸²æŸ“å¤±è´¥:", error);
            splitBtn.disabled = true;
        }
    }

    // --- åˆ‡å‰²ç¤ºæ„å›¾é€»è¾‘ (ç°åœ¨ä½¿ç”¨ Canvas çš„æ¸²æŸ“å°ºå¯¸) ---
    function drawVisualization(width, height, mode) {
        overlayCanvas.width = width;
        overlayCanvas.height = height;
        ctx.clearRect(0, 0, width, height);

        ctx.save();
        
        // è®¡ç®—å®é™…è¾¹ç•Œä½ç½®
        const actualTop = customBoundaries.top * height;
        const actualBottom = customBoundaries.bottom * height;
        const actualLeft = customBoundaries.left * width;
        const actualRight = customBoundaries.right * width;
        
        // ç»˜åˆ¶è¾¹ç•Œæ¡†
        ctx.strokeStyle = '#28a745';
        ctx.lineWidth = 2;
        ctx.setLineDash([]);
        ctx.strokeRect(actualLeft, actualTop, actualRight - actualLeft, actualBottom - actualTop);
        
        // ç»˜åˆ¶åˆ‡å‰²çº¿
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 4;
        ctx.setLineDash([15, 8]); // è™šçº¿

        if (mode === 'vertical') {
            const splitX = actualLeft + (actualRight - actualLeft) * customSplitPosition;
            ctx.beginPath();
            ctx.moveTo(splitX, actualTop);
            ctx.lineTo(splitX, actualBottom);
            ctx.stroke();

            // æ ‡è®°æ–‡æœ¬
            ctx.fillStyle = 'red';
            ctx.font = '24px sans-serif';
            ctx.textAlign = 'center';
            const leftCenterX = actualLeft + (splitX - actualLeft) / 2;
            const rightCenterX = splitX + (actualRight - splitX) / 2;
            ctx.fillText("å·¦é¡µ", leftCenterX, (actualTop + actualBottom) / 2);
            ctx.fillText("å³é¡µ", rightCenterX, (actualTop + actualBottom) / 2);

        } else if (mode === 'horizontal') {
            const splitY = actualTop + (actualBottom - actualTop) * customSplitPosition;
            ctx.beginPath();
            ctx.moveTo(actualLeft, splitY);
            ctx.lineTo(actualRight, splitY);
            ctx.stroke();

            // æ ‡è®°æ–‡æœ¬
            ctx.fillStyle = 'red';
            ctx.font = '24px sans-serif';
            ctx.textAlign = 'center';
            const topCenterY = actualTop + (splitY - actualTop) / 2;
            const bottomCenterY = splitY + (actualBottom - splitY) / 2;
            ctx.fillText("ä¸Šé¡µ", (actualLeft + actualRight) / 2, topCenterY);
            ctx.fillText("ä¸‹é¡µ", (actualLeft + actualRight) / 2, bottomCenterY);
        }
        ctx.restore();
        
        // æ›´æ–°æ§åˆ¶ç‚¹ä½ç½®
        updateControlHandles(width, height, mode);
    }
    
    // æ›´æ–°æ§åˆ¶ç‚¹ä½ç½®
    function updateControlHandles(width, height, mode) {
        const actualTop = customBoundaries.top * height;
        const actualBottom = customBoundaries.bottom * height;
        const actualLeft = customBoundaries.left * width;
        const actualRight = customBoundaries.right * width;
        
        // æ˜¾ç¤ºæ§åˆ¶ç‚¹
        splitHandle.style.display = 'block';
        topHandle.style.display = 'block';
        bottomHandle.style.display = 'block';
        leftHandle.style.display = 'block';
        rightHandle.style.display = 'block';
        
        // è®¾ç½®åˆ†å‰²çº¿æ§åˆ¶ç‚¹ä½ç½®
        if (mode === 'vertical') {
            const splitX = actualLeft + (actualRight - actualLeft) * customSplitPosition;
            splitHandle.style.left = (splitX - 10) + 'px';
            splitHandle.style.top = (actualTop + (actualBottom - actualTop) / 2 - 10) + 'px';
        } else {
            const splitY = actualTop + (actualBottom - actualTop) * customSplitPosition;
            splitHandle.style.left = (actualLeft + (actualRight - actualLeft) / 2 - 10) + 'px';
            splitHandle.style.top = (splitY - 10) + 'px';
        }
        
        // è®¾ç½®è¾¹ç•Œæ§åˆ¶ç‚¹ä½ç½®
        topHandle.style.top = (actualTop - 8) + 'px';
        bottomHandle.style.top = (actualBottom - 8) + 'px';
        leftHandle.style.left = (actualLeft - 8) + 'px';
        rightHandle.style.left = (actualRight - 8) + 'px';
    }
    
    // --- æ‹–æ‹½äº‹ä»¶å¤„ç† ---
    function setupDragHandlers() {
        const handles = [splitHandle, topHandle, bottomHandle, leftHandle, rightHandle];
        
        handles.forEach(handle => {
            // é¼ æ ‡äº‹ä»¶
            handle.addEventListener('mousedown', startDrag);
            
            // è§¦æ‘¸äº‹ä»¶
            handle.addEventListener('touchstart', startDrag, { passive: false });
        });
        
        // é¼ æ ‡äº‹ä»¶
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);
        
        // è§¦æ‘¸äº‹ä»¶
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('touchend', endDrag);
    }
    
    function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        dragTarget = e.target;
        
        // å¤„ç†è§¦æ‘¸äº‹ä»¶å’Œé¼ æ ‡äº‹ä»¶
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        dragStartPos = { x: clientX, y: clientY };
        dragTarget.classList.add('dragging');
    }
    
    function drag(e) {
        if (!isDragging || !dragTarget) return;
        
        e.preventDefault();
        
        const rect = previewWrapper.getBoundingClientRect();
        
        // å¤„ç†è§¦æ‘¸äº‹ä»¶å’Œé¼ æ ‡äº‹ä»¶
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        const width = previewCanvas.width;
        const height = previewCanvas.height;
        
        // é™åˆ¶åœ¨ç”»å¸ƒèŒƒå›´å†…
        const clampedX = Math.max(0, Math.min(width, x));
        const clampedY = Math.max(0, Math.min(height, y));
        
        if (dragTarget === splitHandle) {
            // æ‹–æ‹½åˆ†å‰²çº¿
            if (splitModeEl.value === 'vertical') {
                customSplitPosition = (clampedX - customBoundaries.left * width) / ((customBoundaries.right - customBoundaries.left) * width);
            } else {
                customSplitPosition = (clampedY - customBoundaries.top * height) / ((customBoundaries.bottom - customBoundaries.top) * height);
            }
            customSplitPosition = Math.max(0.1, Math.min(0.9, customSplitPosition)); // é™åˆ¶åœ¨10%-90%ä¹‹é—´
        } else if (dragTarget === topHandle) {
            customBoundaries.top = Math.max(0, Math.min(customBoundaries.bottom - 0.1, clampedY / height));
        } else if (dragTarget === bottomHandle) {
            customBoundaries.bottom = Math.max(customBoundaries.top + 0.1, Math.min(1, clampedY / height));
        } else if (dragTarget === leftHandle) {
            customBoundaries.left = Math.max(0, Math.min(customBoundaries.right - 0.1, clampedX / width));
        } else if (dragTarget === rightHandle) {
            customBoundaries.right = Math.max(customBoundaries.left + 0.1, Math.min(1, clampedX / width));
        }
        
        // é‡æ–°ç»˜åˆ¶
        drawVisualization(width, height, splitModeEl.value);
    }
    
    function endDrag() {
        if (isDragging && dragTarget) {
            dragTarget.classList.remove('dragging');
        }
        isDragging = false;
        dragTarget = null;
    }

    // --- äº‹ä»¶å¤„ç†å’Œ PDF-LIB åˆ‡å‰²é€»è¾‘ ---

    // é‡æ–°æ¸²æŸ“é¢„è§ˆå’Œåˆ‡å‰²ç¤ºæ„å›¾ (å“åº”å¼è°ƒæ•´æˆ–æ¨¡å¼åˆ‡æ¢)
    function updatePreview() {
        if (pdfDataUrl) {
            renderPagePreview(pdfDataUrl); 
        } else {
             drawVisualization(ASSUMED_A3_WIDTH, ASSUMED_A3_HEIGHT, splitModeEl.value);
        }
    }

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ˆå®ç°å“åº”å¼ï¼‰
    window.addEventListener('resize', () => {
        if (pdfDataUrl) {
            // é‡æ–°æ¸²æŸ“é¢„è§ˆå’Œç¤ºæ„å›¾
            updatePreview();
        }
    });

    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    pdfFileEl.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        splitBtn.disabled = true;
        
        try {
            // ã€æ–°å¢ã€‘å­˜å‚¨åŸå§‹æ–‡ä»¶å
            originalFileName = file.name;

            const arrayBuffer = await file.arrayBuffer();
            originalPdfDoc = await PDFDocument.load(arrayBuffer);
            
            if (originalPdfDoc.getPageCount() === 0) {
                throw new Error("PDF æ–‡ä»¶ä¸åŒ…å«ä»»ä½•é¡µé¢ã€‚");
            }

            // åˆ›å»º Data URL ç”¨äº pdf.js æ¸²æŸ“
            const blob = new Blob([arrayBuffer], { type: 'application/pdf' });
            pdfDataUrl = URL.createObjectURL(blob);
            
            await renderPagePreview(pdfDataUrl);
            
            // é‡ç½®è‡ªå®šä¹‰è¾¹ç•Œä¸ºé»˜è®¤å€¼
            customBoundaries = { top: 0, bottom: 1, left: 0, right: 1 };
            customSplitPosition = 0.5;
            
            splitBtn.disabled = false;
            downloadBtn.style.display = 'none';
            splitPdfBytes = null;

        } catch (error) {
            alert('åŠ è½½ PDF æ–‡ä»¶å¤±è´¥: ' + error.message);
            console.error(error);
            splitBtn.disabled = true;
            pageDimensionsEl.textContent = 'N/A';
            previewHint.textContent = "PDF æ–‡ä»¶åŠ è½½å¤±è´¥ã€‚";
        }
    });

    // åˆ‡å‰²æ¨¡å¼æ”¹å˜æ—¶é‡æ–°ç»˜åˆ¶å¯è§†åŒ–
    splitModeEl.addEventListener('change', () => {
        // é‡ç½®åˆ†å‰²çº¿ä½ç½®ä¸ºä¸­é—´
        customSplitPosition = 0.5;
        
        if (pdfDataUrl) {
            // åªéœ€è¦é‡ç»˜åˆ‡å‰²ç¤ºæ„å›¾
            updatePreview();
        } else {
            drawVisualization(ASSUMED_A3_WIDTH, ASSUMED_A3_HEIGHT, splitModeEl.value);
        }
    });

    // --- PDF-LIB åˆ‡å‰²é€»è¾‘ (ä¿æŒå¤šé¡µå¤„ç†å’Œ embedPage) ---
    async function splitAndDownload() {
        if (!originalPdfDoc) {
            alert('è¯·å…ˆä¸Šä¼  PDF æ–‡ä»¶ã€‚');
            return;
        }

        splitBtn.disabled = true;
        splitBtn.textContent = 'æ­£åœ¨åˆ‡å‰²... è¯·ç¨å€™';

        try {
            const newPdfDoc = await PDFDocument.create();
            const totalPages = originalPdfDoc.getPageCount();
            const mode = splitModeEl.value;

            for (let i = 0; i < totalPages; i++) {
                const currentPage = originalPdfDoc.getPage(i);
                
                // 1. è·å–å½“å‰é¡µé¢çš„å°ºå¯¸ (å¦‚æœæœ‰æ•ˆï¼Œå¦åˆ™ä½¿ç”¨å‡å®šå°ºå¯¸)
                let currentW = currentPage.getWidth();
                let currentH = currentPage.getHeight();

                if (!currentW || !currentH || currentW <= 0 || currentH <= 0 || isNaN(currentW) || isNaN(currentH)) {
                    currentW = ASSUMED_A3_WIDTH;
                    currentH = ASSUMED_A3_HEIGHT;
                }

                // 2. åµŒå…¥å½“å‰é¡µé¢
                const embeddedPage = await newPdfDoc.embedPage(currentPage);
                
                // 3. è®¡ç®—è‡ªå®šä¹‰è¾¹ç•Œå’Œåˆ‡å‰²ä½ç½®
                const cropLeft = customBoundaries.left * currentW;
                const cropRight = customBoundaries.right * currentW;
                const cropTop = customBoundaries.top * currentH;
                const cropBottom = customBoundaries.bottom * currentH;
                const cropWidth = cropRight - cropLeft;
                const cropHeight = cropBottom - cropTop;
                
                // 3. åˆ‡å‰²é€»è¾‘
                if (mode === 'vertical') {
                    const splitX = cropLeft + cropWidth * customSplitPosition;
                    const leftWidth = splitX - cropLeft;
                    const rightWidth = cropRight - splitX;
                    
                    // åˆ›å»ºä¸¤ä¸ªA4é¡µé¢ (595.28 x 841.89 pts)
                    const page1 = newPdfDoc.addPage([595.28, 841.89]); 
                    const page2 = newPdfDoc.addPage([595.28, 841.89]); 

                    // A4-1 (å·¦åŠéƒ¨åˆ†) - å…ˆè£å‰ªï¼Œå†é“ºæ»¡A4é¡µé¢
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿å†…å®¹é“ºæ»¡A4é¡µé¢
                    const leftScale = Math.min(595.28 / leftWidth, 841.89 / cropHeight);
                    const leftScaledWidth = leftWidth * leftScale;
                    const leftScaledHeight = cropHeight * leftScale;
                    
                    // è®¡ç®—å±…ä¸­åç§»
                    const leftOffsetX = (595.28 - leftScaledWidth) / 2;
                    const leftOffsetY = (841.89 - leftScaledHeight) / 2;
                    
                    // ç»˜åˆ¶å®Œæ•´é¡µé¢ï¼Œç„¶åè£å‰ª
                    page1.drawPage(embeddedPage, { 
                        x: leftOffsetX - cropLeft * leftScale, 
                        y: leftOffsetY - cropTop * leftScale, 
                        width: currentW * leftScale, 
                        height: currentH * leftScale
                    });
                    
                    // ç²¾ç¡®è£å‰ªåˆ°å·¦åŠéƒ¨åˆ†
                    page1.setCropBox(leftOffsetX, leftOffsetY, leftScaledWidth, leftScaledHeight);

                    // A4-2 (å³åŠéƒ¨åˆ†) - å…ˆè£å‰ªï¼Œå†é“ºæ»¡A4é¡µé¢
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿å†…å®¹é“ºæ»¡A4é¡µé¢
                    const rightScale = Math.min(595.28 / rightWidth, 841.89 / cropHeight);
                    const rightScaledWidth = rightWidth * rightScale;
                    const rightScaledHeight = cropHeight * rightScale;
                    
                    // è®¡ç®—å±…ä¸­åç§»
                    const rightOffsetX = (595.28 - rightScaledWidth) / 2;
                    const rightOffsetY = (841.89 - rightScaledHeight) / 2;
                    
                    // ç»˜åˆ¶å®Œæ•´é¡µé¢ï¼Œç„¶åè£å‰ª
                    page2.drawPage(embeddedPage, { 
                        x: rightOffsetX - splitX * rightScale, 
                        y: rightOffsetY - cropTop * rightScale, 
                        width: currentW * rightScale, 
                        height: currentH * rightScale
                    });
                    
                    // ç²¾ç¡®è£å‰ªåˆ°å³åŠéƒ¨åˆ†
                    page2.setCropBox(rightOffsetX, rightOffsetY, rightScaledWidth, rightScaledHeight);
                    
                } else if (mode === 'horizontal') {
                    const splitY = cropTop + cropHeight * customSplitPosition;
                    const topHeight = splitY - cropTop;
                    const bottomHeight = cropBottom - splitY;
                    
                    // åˆ›å»ºä¸¤ä¸ªA4é¡µé¢ (595.28 x 841.89 pts)
                    const page1 = newPdfDoc.addPage([595.28, 841.89]);
                    const page2 = newPdfDoc.addPage([595.28, 841.89]);

                    // A4-1 (ä¸ŠåŠéƒ¨åˆ†) - å…ˆè£å‰ªï¼Œå†é“ºæ»¡A4é¡µé¢
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿å†…å®¹é“ºæ»¡A4é¡µé¢
                    const topScale = Math.min(595.28 / cropWidth, 841.89 / topHeight);
                    const topScaledWidth = cropWidth * topScale;
                    const topScaledHeight = topHeight * topScale;
                    
                    // è®¡ç®—å±…ä¸­åç§»
                    const topOffsetX = (595.28 - topScaledWidth) / 2;
                    const topOffsetY = (841.89 - topScaledHeight) / 2;
                    
                    // ç»˜åˆ¶å®Œæ•´é¡µé¢ï¼Œç„¶åè£å‰ª
                    page1.drawPage(embeddedPage, { 
                        x: topOffsetX - cropLeft * topScale, 
                        y: topOffsetY - cropTop * topScale, 
                        width: currentW * topScale, 
                        height: currentH * topScale
                    });
                    
                    // ç²¾ç¡®è£å‰ªåˆ°ä¸ŠåŠéƒ¨åˆ†
                    page1.setCropBox(topOffsetX, topOffsetY, topScaledWidth, topScaledHeight);

                    // A4-2 (ä¸‹åŠéƒ¨åˆ†) - å…ˆè£å‰ªï¼Œå†é“ºæ»¡A4é¡µé¢
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿å†…å®¹é“ºæ»¡A4é¡µé¢
                    const bottomScale = Math.min(595.28 / cropWidth, 841.89 / bottomHeight);
                    const bottomScaledWidth = cropWidth * bottomScale;
                    const bottomScaledHeight = bottomHeight * bottomScale;
                    
                    // è®¡ç®—å±…ä¸­åç§»
                    const bottomOffsetX = (595.28 - bottomScaledWidth) / 2;
                    const bottomOffsetY = (841.89 - bottomScaledHeight) / 2;
                    
                    // ç»˜åˆ¶å®Œæ•´é¡µé¢ï¼Œç„¶åè£å‰ª
                    page2.drawPage(embeddedPage, { 
                        x: bottomOffsetX - cropLeft * bottomScale, 
                        y: bottomOffsetY - splitY * bottomScale, 
                        width: currentW * bottomScale, 
                        height: currentH * bottomScale
                    });
                    
                    // ç²¾ç¡®è£å‰ªåˆ°ä¸‹åŠéƒ¨åˆ†
                    page2.setCropBox(bottomOffsetX, bottomOffsetY, bottomScaledWidth, bottomScaledHeight);
                }
                
                splitBtn.textContent = `æ­£åœ¨åˆ‡å‰²... (å·²å®Œæˆ ${i + 1}/${totalPages} é¡µ)`;
            }

            // 4. åºåˆ—åŒ–æ–°çš„ PDF
            splitPdfBytes = await newPdfDoc.save();
            downloadBtn.style.display = 'block';
            splitBtn.textContent = 'åˆ‡å‰²å®Œæˆï¼';

        } catch (error) {
            alert('PDF åˆ‡å‰²å¤±è´¥: ' + error.message);
            console.error(error);
            splitBtn.textContent = 'æ­¥éª¤ 3: åˆ‡å‰²å¹¶ç”Ÿæˆ A4 PDF';
        } finally {
            if (splitBtn.textContent !== 'åˆ‡å‰²å®Œæˆï¼') {
                 splitBtn.disabled = false;
            }
        }
    }

    // ä¸‹è½½æ–‡ä»¶
    downloadBtn.addEventListener('click', () => {
        if (splitPdfBytes) {
            // ã€ä¿®æ”¹ã€‘æ„å»ºæ–°çš„æ–‡ä»¶å
            let baseName = originalFileName.replace(/\.pdf$/i, '');
            const newFileName = `${baseName}_split.pdf`;

            const blob = new Blob([splitPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = newFileName; // ä½¿ç”¨æ–°æ–‡ä»¶å
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    });
    
    // æ£€æµ‹ç§»åŠ¨è®¾å¤‡
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
               window.innerWidth <= 768;
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåé»˜è®¤ç»˜åˆ¶ä¸€ä¸ªå ä½ç¤ºæ„å›¾
    window.onload = () => {
        // åˆå§‹åŒ–æ‹–æ‹½å¤„ç†å™¨
        setupDragHandlers();
        
        // é‡ç½®è‡ªå®šä¹‰è¾¹ç•Œä¸ºé»˜è®¤å€¼
        customBoundaries = { top: 0, bottom: 1, left: 0, right: 1 };
        customSplitPosition = 0.5;
        
        // æ£€æµ‹ç§»åŠ¨è®¾å¤‡å¹¶æ˜¾ç¤ºç›¸åº”æç¤º
        if (isMobileDevice()) {
            const mobileHint = document.querySelector('.mobile-hint');
            if (mobileHint) {
                mobileHint.style.display = 'block';
            }
        }
        
        drawVisualization(ASSUMED_A3_WIDTH, ASSUMED_A3_HEIGHT, 'vertical'); 
        previewCanvas.width = 842;
        previewCanvas.height = 595;
        previewWrapper.style.paddingTop = '70.6%'; // 595.28 / 841.89 * 100
    };

</script>
</body>
</html>