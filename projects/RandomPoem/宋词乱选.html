<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宋词乱选</title>
</head>
<body>
    <h1>宋词乱选</h1>
    
    <div>
        <h2>选择词牌</h2>
        <button onclick="toggleCipaiList()">展开/折叠词牌列表</button>
        <div id="cipaiList" style="display:none;">
            <div id="cipaiItems"></div>
        </div>
    </div>
    
    <div>
        <h2>操作</h2>
        <button onclick="generateRandom()" id="generateBtn" disabled>随机生成</button>
    </div>
    
    <div id="result" style="display:none;">
        <h2>生成结果</h2>
        <div id="resultCipai"></div>
        <div id="resultContent" style="white-space: pre-line;"></div>
    </div>

    <script>
        const cipaiList = [
            "浣溪沙","水調歌頭","兵要望江南","菩薩蠻","鷓鴣天","滿江紅","西江月","臨江仙","失調名","念奴嬌",
            "沁園春","蝶戀花","減字木蘭花","點絳唇","清平樂","賀新郎","滿庭芳","虞美人","十二時","水龍吟",
            "好事近","漁家傲","朝中措","南鄉子","謁金門","卜算子","南歌子","玉樓春","踏莎行","生查子",
            "望江南","浪淘沙","柳梢青","驀山溪","鵲橋仙","如夢令","訴衷情","木蘭花慢","洞仙歌","阮郎歸",
            "楊柳枝","青玉案","江城子","醉落魄","摸魚兒","長相思","瑞鶴仙","小重山","感皇恩","木蘭花",
            "喜遷鶯","八聲甘州","憶秦娥","醉蓬萊","定風波","霜天曉角","酹江月","導引","齊天樂","眼兒媚",
            "更漏子","采桑子","少年遊","永遇樂","江神子","漢宮春","千秋歲","祝英臺近","聲聲慢","五更轉",
            "風入松","漁父","酒泉子","一翦梅","行香子","瑞鷓鴣","醜奴兒","烏夜啼","漁父詞","風流子",
            "桃源憶故人","南柯子","燭影搖紅","採桑子","武陵春","最高樓","鳳棲梧","夜行船","杏花天","一落索",
            "醉桃源","天仙子","秦樓月","水鼓子","撥棹歌","望海潮","應天長","擣練子","憶王孫","畫堂春"
        ];
        let poemsData = [];
        let selectedCipai = null;
        // 按词牌名分组，每项为 { poem, sentences }
        let cipaiMap = {};

        // 加载JSON数据
        async function loadPoemsData() {
            const response = await fetch('data/全宋词.json');
            poemsData = await response.json();
            
            // 按词牌分组，并预先拆分句子
            cipaiMap = {};
            poemsData.forEach(poem => {
                const cipai = poem.cipai || '';
                if (cipai) {
                    if (!cipaiMap[cipai]) {
                        cipaiMap[cipai] = [];
                    }
                    cipaiMap[cipai].push({
                        poem,
                        sentences: splitSentences(poem.content || '')
                    });
                }
            });
        }

        // 渲染词牌列表
        function renderCipaiList() {
            const container = document.getElementById('cipaiItems');
            container.innerHTML = '';
            cipaiList.forEach(cipai => {
                const div = document.createElement('div');
                div.textContent = cipai;
                div.style.cursor = 'pointer';
                div.style.padding = '5px';
                div.style.border = '1px solid #ccc';
                div.style.margin = '2px';
                div.onclick = () => selectCipai(cipai);
                if (selectedCipai === cipai) {
                    div.style.backgroundColor = '#e0e0e0';
                }
                container.appendChild(div);
            });
        }

        // 选择词牌
        function selectCipai(cipai) {
            selectedCipai = cipai;
            renderCipaiList();
            document.getElementById('generateBtn').disabled = false;
        }

        // 切换词牌列表显示
        function toggleCipaiList() {
            const list = document.getElementById('cipaiList');
            list.style.display = list.style.display === 'none' ? 'block' : 'none';
        }

        // 按标点分句（句号、逗号等都算一句，保留末尾标点）
        function splitSentences(text) {
            const matches = text.match(/[^，。、；：！？]+[，。、；：！？]?/g);
            return matches ? matches.map(s => s.trim()).filter(Boolean) : [];
        }

        // 将文字填充到模板的标点结构中
        function fillTemplateWithWords(template, words) {
            if (!words || words.length === 0) {
                return template;
            }
            
            let result = '';
            let wordIndex = 0;
            
            // 遍历模板的每个字符
            for (let i = 0; i < template.length; i++) {
                const char = template[i];
                // 如果是标点符号或空格，直接保留
                if (/[，。、；：！？\s]/.test(char)) {
                    result += char;
                } else if (/[\u4e00-\u9fa5]/.test(char)) {
                    // 如果是汉字位置，填充随机文字（循环使用）
                    result += words[wordIndex % words.length];
                    wordIndex++;
                } else {
                    // 其他字符（如标点符号的其他形式）也保留
                    result += char;
                }
            }
            
            return result;
        }

        // 随机生成
        function generateRandom() {
            if (!selectedCipai || !cipaiMap[selectedCipai]) {
                alert('请先选择词牌');
                return;
            }

            const entries = cipaiMap[selectedCipai];
            if (entries.length === 0) {
                alert('该词牌下没有数据');
                return;
            }

            // 随机选择一首作为模板
            const templateEntry = entries[Math.floor(Math.random() * entries.length)];
            const templateSentences = templateEntry.sentences;

            // 生成新词
            const newSentences = [];
            for (let i = 0; i < templateSentences.length; i++) {
                const templateSentence = templateSentences[i];
                
                // 选择拥有第 i 句的词作为来源
                const candidates = entries.filter(e => e.sentences.length > i);
                if (candidates.length === 0) {
                    newSentences.push(templateSentence);
                    continue;
                }

                const source = candidates[Math.floor(Math.random() * candidates.length)];
                const selectedSentence = source.sentences[i];

                // 提取选中句子的所有汉字（去掉标点和空格）
                const words = selectedSentence.match(/[\u4e00-\u9fa5]/g) || [];

                // 将文字填充到模板的标点结构中
                const newSentence = fillTemplateWithWords(templateSentence, words.join(''));
                newSentences.push(newSentence);
            }

            // 组合最终结果，并在句号/问号/感叹号后换行（含全角半角）
            const resultContent = newSentences
                .join(' ')
                .replace(/([。！？?!])/g, '$1\n');

            // 显示结果
            document.getElementById('resultCipai').textContent = '词牌：' + selectedCipai;
            document.getElementById('resultContent').textContent = resultContent;
            document.getElementById('result').style.display = 'block';
        }

        // 初始化
        async function init() {
            renderCipaiList(); // 直接使用写死的词牌列表
            await loadPoemsData();
        }

        init();
    </script>
</body>
</html>

